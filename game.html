<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Space Shooter</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #000;
            overflow: hidden;
            font-family: Arial, sans-serif;
            touch-action: none;
        }
        
        #game-container {
            position: relative;
            width: 100%;
            height: 100vh;
            overflow: hidden;
        }
        
        #game-canvas {
            width: 100%;
            height: 100%;
            display: block;
        }
        
        #start-screen, #game-over-screen, #high-score-screen, #how-to-play-screen, #pause-screen, #settings-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            z-index: 10;
            transition: opacity 0.5s;
        }
        
        #game-over-screen, #high-score-screen, #how-to-play-screen, #pause-screen, #settings-screen {
            display: none;
        }
        
        #start-screen svg {
            width: 80%;
            max-width: 800px;
            height: auto;
            margin-bottom: 20px;
        }
        
        button {
            background-color: #0f0;
            color: #000;
            border: none;
            padding: 10px 20px;
            margin: 10px;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s;
            font-family: 'Orbitron', sans-serif; /* Sci-fi font for buttons */
        }
        
        button:hover {
            background-color: #00ff00;
            transform: scale(1.05);
            box-shadow: 0 0 10px #0f0;
        }
        
        #score-display {
            position: absolute;
            top: 10px;
            left: 10px;
            color: white;
            font-size: 20px;
            z-index: 5;
            font-family: 'Orbitron', sans-serif; /* Sci-fi font for score */
        }
        
        #combo-display {
            position: absolute;
            top: 40px;
            left: 10px;
            color: #ff0;
            font-size: 18px;
            z-index: 5;
            font-family: 'Orbitron', sans-serif; /* Sci-fi font for combo */
        }
        
        #mobile-controls {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 30%;
            display: none;
            z-index: 20;
        }
        
        .control-btn {
            background-color: rgba(0, 255, 0, 0.3);
            border: 2px solid rgba(0, 255, 0, 0.7);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 36px;
            touch-action: none;
        }
        
        #joystick-container {
            position: absolute;
            bottom: 10px;
            left: 10px;
            width: 40%;
            height: 100%;
        }
        
        #joystick-area {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 120px;
            height: 120px;
        }
        
        #joystick-thumb {
            position: absolute;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background-color: rgba(0, 255, 0, 0.6);
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            transition: transform 0.05s ease-out;
        }
        
        #fire-btn-container {
            position: absolute;
            bottom: 10px;
            right: 10px;
            width: 40%;
            height: 100%;
            display: flex;
            justify-content: flex-end;
            align-items: flex-end;
        }
        
        #fire-btn {
            width: 120px;
            height: 120px;
        }
        
        table {
            border-collapse: collapse;
            margin-top: 20px;
            color: white;
        }
        
        th, td {
            border: 1px solid #0f0;
            padding: 8px;
            text-align: center;
        }
        
        th {
            background-color: rgba(0, 255, 0, 0.2);
        }
        
        input, select {
            padding: 10px;
            margin: 10px;
            border-radius: 5px;
            border: 1px solid #0f0;
            background-color: #000;
            color: white;
        }
        
        #high-scores-table {
            max-height: 200px;
            overflow-y: auto;
        }

        audio {
            display: none;
        }

        #settings-screen .settings-container {
            max-width: 600px;
            text-align: center;
            margin: 20px;
        }

        #settings-screen .color-selector {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 20px auto;
            width: 100%;
        }

        #settings-screen .color-preview {
            width: 80px;
            height: 100px;
            margin: 0 20px;
            position: relative;
        }

        #settings-screen .color-preview-canvas {
            width: 100%;
            height: 100%;
        }

        #settings-screen .arrow-btn {
            background-color: #0f0;
            width: 40px;
            height: 40px;
            font-size: 24px;
            padding: 0;
        }

        @media (max-width: 768px) {
            #start-screen svg {
                width: 90%;
                max-width: 400px;
            }
            
            button {
                padding: 8px 16px;
                font-size: 14px;
            }
            
            #score-display, #combo-display {
                font-size: 16px;
            }

            #settings-screen .color-preview {
                width: 60px;
                height: 75px;
            }

            #settings-screen .arrow-btn {
                width: 30px;
                height: 30px;
                font-size: 18px;
            }
        }
    </style>
</head>
<body>
    <div id="game-container">
        <canvas id="game-canvas"></canvas>
        
        <div id="score-display">Score: 0 | Lives: ★★★</div>
        <div id="combo-display">Combo: x1</div>
        
        <div id="start-screen">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 800 450" preserveAspectRatio="xMidYMid meet">
                <rect width="800" height="450" fill="#000"/>
                <g id="stars">
                    <circle cx="50" cy="50" r="1" fill="white"/>
                    <circle cx="150" cy="80" r="1.5" fill="white"/>
                    <circle cx="250" cy="30" r="1" fill="white"/>
                    <circle cx="350" cy="60" r="2" fill="white"/>
                    <circle cx="450" cy="40" r="1" fill="white"/>
                    <circle cx="550" cy="90" r="1.5" fill="white"/>
                    <circle cx="650" cy="35" r="1" fill="white"/>
                    <circle cx="750" cy="75" r="2" fill="white"/>
                    <circle cx="100" cy="150" r="1.5" fill="white"/>
                    <circle cx="200" cy="120" r="1" fill="white"/>
                    <circle cx="300" cy="180" r="2" fill="white"/>
                    <circle cx="400" cy="130" r="1" fill="white"/>
                    <circle cx="500" cy="170" r="1.5" fill="white"/>
                    <circle cx="600" cy="140" r="1" fill="white"/>
                    <circle cx="700" cy="160" r="2" fill="white"/>
                    <circle cx="75" cy="250" r="1" fill="white"/>
                    <circle cx="175" cy="230" r="1.5" fill="white"/>
                    <circle cx="275" cy="270" r="1" fill="white"/>
                    <circle cx="375" cy="220" r="2" fill="white"/>
                    <circle cx="475" cy="280" r="1" fill="white"/>
                    <circle cx="575" cy="240" r="1.5" fill="white"/>
                    <circle cx="675" cy="260" r="1" fill="white"/>
                    <circle cx="125" cy="340" r="2" fill="white"/>
                    <circle cx="225" cy="320" r="1" fill="white"/>
                    <circle cx="325" cy="350" r="1.5" fill="white"/>
                    <circle cx="425" cy="310" r="1" fill="white"/>
                    <circle cx="525" cy="360" r="2" fill="white"/>
                    <circle cx="625" cy="330" r="1" fill="white"/>
                    <circle cx="725" cy="370" r="1.5" fill="white"/>
                    <circle cx="25" cy="410" r="1" fill="white"/>
                    <circle cx="720" cy="420" r="1" fill="white"/>
                    <circle cx="600" cy="390" r="1.5" fill="white"/>
                    <circle cx="180" cy="430" r="1" fill="white"/>
                    <circle cx="435" cy="400" r="1.2" fill="white"/>
                    <circle cx="335" cy="440" r="1" fill="white"/>
                    <circle cx="645" cy="40" r="1.8" fill="white"/>
                    <circle cx="240" cy="145" r="1.7" fill="white"/>
                    <circle cx="340" cy="75" r="1.3" fill="white"/>
                    <circle cx="140" cy="185" r="1.1" fill="white"/>
                    <circle cx="545" cy="190" r="1.6" fill="white"/>
                </g>
                
                <text x="400" y="100" font-family="'Orbitron', sans-serif" font-size="60" font-weight="bold" 
                      text-anchor="middle" fill="#0f0" stroke="#000" stroke-width="2" 
                      style="filter: drop-shadow(0 0 10px #0f0);">
                    <tspan x="400" dy="-20">SPACE</tspan>
                    <tspan x="400" dy="60">SHOOTER</tspan>
                </text>
                
                <g transform="translate(400, 280) scale(1)">
                    <path d="M0 -45 L25 15 L-25 15 Z" fill="#0f0"/>
                    <path d="M-12 15 L0 35 L12 15 Z" fill="rgba(255, 165, 0, 0.8)"/>
                    <path d="M-2 -45 L2 -45 L2 -120 L-2 -120 Z" fill="rgba(0, 255, 0, 0.7)"/>
                    <circle cx="0" cy="-120" r="8" fill="rgba(0, 255, 0, 0.5)"/>
                </g>
                
                <g transform="translate(250, 180) scale(0.8)">
                    <path d="M0 -20 L20 20 L-20 20 Z" fill="#f00" transform="rotate(180)"/>
                    <path d="M-5 -20 L0 -30 L5 -20 Z" fill="rgba(255, 165, 0, 0.8)" transform="rotate(180)"/>
                </g>
                <g transform="translate(550, 180) scale(0.8)">
                    <path d="M0 -20 L20 20 L-20 20 Z" fill="#f00" transform="rotate(180)"/>
                    <path d="M-5 -20 L0 -30 L5 -20 Z" fill="rgba(255, 165, 0, 0.8)" transform="rotate(180)"/>
                </g>
                
                <g transform="translate(650, 220) scale(0.8)">
                    <circle cx="0" cy="0" r="25" fill="rgba(255, 165, 0, 0.9)"/>
                    <circle cx="0" cy="0" r="15" fill="rgba(255, 255, 0, 0.8)"/>
                </g>
                <rect x="180" y="200" width="20" height="20" fill="#ff0" transform="scale(0.8)"/>
            </svg>
            <button id="start-btn">START YOUR MISSION</button>
            <button id="high-scores-btn">HIGH SCORES</button>
            <button id="how-to-play-btn">HOW TO PLAY</button>
            <button id="settings-btn">SETTINGS</button>
        </div>
        
        <div id="game-over-screen">
            <h2>GAME OVER</h2>
            <p id="final-score">Your score: 0</p>
            <input type="text" id="player-name" placeholder="Enter your name" maxlength="10">
            <button id="save-score-btn">SAVE SCORE</button>
            <button id="play-again-btn">PLAY AGAIN</button>
            <button id="back-to-menu-btn">MAIN MENU</button>
        </div>
        
        <div id="high-score-screen">
            <h2>HIGH SCORES</h2>
            <div id="high-scores-table">
                <table>
                    <thead>
                        <tr>
                            <th>Rank</th>
                            <th>Name</th>
                            <th>Score</th>
                        </tr>
                    </thead>
                    <tbody id="high-scores-body"></tbody>
                </table>
            </div>
            <button id="reset-scores-btn">RESET HIGH SCORES</button>
            <button id="back-from-scores-btn">BACK</button>
        </div>
        
        <div id="how-to-play-screen">
            <h2>HOW TO PLAY</h2>
            <div style="max-width: 600px; text-align: center; margin: 20px;">
                <p><b>Desktop Controls:</b><br>
                Use mouse to move your spacecraft<br>
                Click or press SPACE to shoot<br>
                Press SHIFT to dash<br>
                Press ESC to pause</p>
                
                <p><b>Mobile Controls:</b><br>
                Use the joystick to move smoothly<br>
                Double-tap joystick to dash<br>
                Tap/hold the fire button to shoot<br>
                Simultaneous controls supported</p>
                
                <p><b>Game Rules:</b><br>
                Destroy enemies for points<br>
                Build combos with consecutive kills<br>
                Collect power-ups (yellow = speed, blue = shield, purple = spread, red = laser, cyan = homing, white = invincibility)<br>
                Avoid enemy fire and collisions<br>
                You have 3 lives</p>
            </div>
            <button id="back-from-help-btn">BACK</button>
        </div>
        
        <div id="pause-screen">
            <h2>PAUSED</h2>
            <button id="resume-btn">RESUME</button>
            <button id="restart-btn">RESTART</button>
            <button id="quit-to-menu-btn">MAIN MENU</button>
        </div>
        
        <div id="settings-screen"></div>
        
        <div id="mobile-controls">
            <div id="joystick-container">
                <div id="joystick-area" class="control-btn">
                    <div id="joystick-thumb"></div>
                </div>
            </div>
            <div id="fire-btn-container">
                <div id="fire-btn" class="control-btn">🔥</div>
            </div>
        </div>

        <audio id="background-music" loop src="https://www.freesoundslibrary.com/wp-content/uploads/2021/07/space-ambient-background.mp3"></audio>
        <audio id="boss-music" loop src="https://www.freesoundslibrary.com/wp-content/uploads/2021/07/epic-space-battle.mp3"></audio>
        <audio id="game-start-sound" src="https://www.soundjay.com/buttons/beep-08b.mp3"></audio>
        <audio id="laser-sound" src="https://www.soundjay.com/buttons/laser6.mp3"></audio>
        <audio id="hit-sound" src="https://www.soundjay.com/buttons/beep-01a.mp3"></audio>
        <audio id="explosion-sound" src="https://www.soundjay.com/mechanical/explosion-01.mp3"></audio>
        <audio id="powerup-sound" src="https://www.soundjay.com/buttons/beep-07.mp3"></audio>
        <audio id="gameover-sound" src="https://www.soundjay.com/buttons/beep-02.mp3"></audio>
        <audio id="combo-sound" src="https://www.soundjay.com/buttons/beep-09.mp3"></audio>
        <audio id="dash-sound" src="https://www.soundjay.com/buttons/beep-10.mp3"></audio>
    </div>
    
    <script>
        const canvas = document.getElementById('game-canvas');
        const ctx = canvas.getContext('2d');
        const scoreDisplay = document.getElementById('score-display');
        const comboDisplay = document.getElementById('combo-display');
        const startScreen = document.getElementById('start-screen');
        const gameOverScreen = document.getElementById('game-over-screen');
        const highScoreScreen = document.getElementById('high-score-screen');
        const howToPlayScreen = document.getElementById('how-to-play-screen');
        const pauseScreen = document.getElementById('pause-screen');
        const settingsScreen = document.getElementById('settings-screen');
        const finalScoreDisplay = document.getElementById('final-score');
        const mobileControls = document.getElementById('mobile-controls');
        const joystickArea = document.getElementById('joystick-area');
        const joystickThumb = document.getElementById('joystick-thumb');
        const fireBtn = document.getElementById('fire-btn');
        const joystickContainer = document.getElementById('joystick-container');
        const fireBtnContainer = document.getElementById('fire-btn-container');

        const backgroundMusic = document.getElementById('background-music');
        const bossMusic = document.getElementById('boss-music');
        const gameStartSound = document.getElementById('game-start-sound');
        const laserSound = document.getElementById('laser-sound');
        const hitSound = document.getElementById('hit-sound');
        const explosionSound = document.getElementById('explosion-sound');
        const powerupSound = document.getElementById('powerup-sound');
        const gameoverSound = document.getElementById('gameover-sound');
        const comboSound = document.getElementById('combo-sound');
        const dashSound = document.getElementById('dash-sound');

        let gameRunning = false;
        let isPaused = false;
        let score = 0;
        let lives = 3;
        let combo = 0;
        let comboMultiplier = 1;
        let lastKillTime = 0;
        let highScores = [];
        let powerUps = [];
        let explosions = [];
        let particles = [];
        let enemySpeedMultiplier = 1;
        let shieldActive = false;
        let shieldTime = 0;
        let difficulty = 'normal';
        let bossActive = false;
        let screenShake = 0;
        let lastBossScore = -5000;
        let soundOn = true;
        let playerColorIndex = 0;
        const playerColors = [
            { name: 'Green', value: '#0f0' },
            { name: 'Blue', value: '#00f' },
            { name: 'Red', value: '#f00' },
            { name: 'Yellow', value: '#ff0' },
            { name: 'Purple', value: '#800080' },
            { name: 'Orange', value: '#ff4500' },
            { name: 'Pink', value: '#ff69b4' },
            { name: 'Cyan', value: '#00ffff' },
            { name: 'Magenta', value: '#ff00ff' },
            { name: 'Lime', value: '#00ff00' },
            { name: 'Teal', value: '#008080' },
            { name: 'Violet', value: '#ee82ee' },
            { name: 'Gold', value: '#ffd700' },
            { name: 'Silver', value: '#c0c0c0' },
            { name: 'Indigo', value: '#4b0082' }
        ];

        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

        const player = {
            x: 0,
            y: 0,
            width: 40,
            height: 50,
            speed: 10, // Increased for smoother movement
            velocityX: 0,
            velocityY: 0,
            bullets: [],
            bulletPool: [],
            lastShot: 0,
            shootDelay: 200, // Slightly faster default shooting
            fireAnimation: 0,
            boosterAnimation: 1,
            weaponType: 'default',
            weaponTime: 0,
            dashCooldown: 1500, // Reduced cooldown for more dynamic play
            lastDash: 0,
            dashDistance: 120 // Slightly increased dash distance
        };

        let enemies = [];
        const enemyPool = Array(30).fill().map(() => ({ active: false, x: 0, y: 0, width: 0, height: 0, speed: 0, health: 0, maxHealth: 0, color: '#f00', bullets: [], lastShot: 0, shootRate: 0, type: '', fireAnimation: 0, boosterAnimation: 1 })); // Increased pool size
        const enemyBulletPool = Array(150).fill().map(() => ({ active: false, x: 0, y: 0, width: 4, height: 10, speed: 6, angle: 0 })); // Increased pool size
        let backgroundStarsSlow = [];
        let backgroundStarsFast = [];
        let enemySpawnRate = 1000; // Reduced initial spawn rate for more enemies
        let lastEnemySpawn = 0;
        let lastTime = 0;
        let animationFrameId;
        let isJoystickActive = false;
        let isFireBtnActive = false;
        let autoFireInterval = null;
        let lastJoystickTap = 0;

        function init() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            player.x = canvas.width / 2 - player.width / 2;
            player.y = canvas.height - player.height - 20;
            
            if (isMobile) mobileControls.style.display = 'block';
            
            const savedScores = localStorage.getItem('spaceShooterHighScores');
            if (savedScores) highScores = JSON.parse(savedScores);
            score = 0;
            lives = 3;
            combo = 0;
            comboMultiplier = 1;
            difficulty = 'normal';
            enemies = [];
            powerUps = [];
            particles = [];
            player.bullets = [];
            player.bulletPool = Array(75).fill().map(() => ({ active: false, x: 0, y: 0, width: 4, height: 10, speed: 12, angle: 0 })); // Increased pool and bullet speed
            enemyPool.forEach(e => e.active = false);
            enemyBulletPool.forEach(b => b.active = false);
            initBackgroundStars();
            updateScoreDisplay();
            updateComboDisplay();
            backgroundMusic.volume = 0.3;
            bossMusic.volume = 0.3;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            canvas.style.cursor = 'default';
            startScreen.style.display = 'flex';
        }

        function initBackgroundStars() {
            backgroundStarsSlow = Array(75).fill().map(() => ({
                x: Math.random() * canvas.width,
                y: Math.random() * canvas.height,
                size: Math.random() * 1.5,
                speed: Math.random() * 0.5 + 0.5
            }));
            backgroundStarsFast = Array(75).fill().map(() => ({
                x: Math.random() * canvas.width,
                y: Math.random() * canvas.height,
                size: Math.random() * 2 + 1,
                speed: Math.random() * 1 + 1
            }));
        }

        function updateScoreDisplay() {
            let livesStr = '★'.repeat(lives) + '☆'.repeat(3 - lives);
            scoreDisplay.textContent = `Score: ${Math.floor(score)} | Lives: ${livesStr}`;
        }

        function updateComboDisplay() {
            comboDisplay.textContent = `Combo: x${comboMultiplier}`;
            if (comboMultiplier > 1) {
                comboDisplay.style.transform = `scale(${1 + (comboMultiplier - 1) * 0.1})`;
                setTimeout(() => comboDisplay.style.transform = 'scale(1)', 200);
            }
        }

        function setupEventListeners() {
            const startBtn = document.getElementById('start-btn');
            const highScoresBtn = document.getElementById('high-scores-btn');
            const howToPlayBtn = document.getElementById('how-to-play-btn');
            const settingsBtn = document.getElementById('settings-btn');
            const playAgainBtn = document.getElementById('play-again-btn');
            const backToMenuBtn = document.getElementById('back-to-menu-btn');
            const backFromScoresBtn = document.getElementById('back-from-scores-btn');
            const backFromHelpBtn = document.getElementById('back-from-help-btn');
            const saveScoreBtn = document.getElementById('save-score-btn');
            const resumeBtn = document.getElementById('resume-btn');
            const restartBtn = document.getElementById('restart-btn');
            const quitToMenuBtn = document.getElementById('quit-to-menu-btn');

            if (startBtn) startBtn.addEventListener('click', startGame);
            if (highScoresBtn) highScoresBtn.addEventListener('click', showHighScores);
            if (howToPlayBtn) howToPlayBtn.addEventListener('click', showHowToPlay);
            if (settingsBtn) settingsBtn.addEventListener('click', showSettings);
            if (playAgainBtn) playAgainBtn.addEventListener('click', startGame);
            if (backToMenuBtn) backToMenuBtn.addEventListener('click', showStartScreen);
            if (backFromScoresBtn) backFromScoresBtn.addEventListener('click', showStartScreen);
            if (backFromHelpBtn) backFromHelpBtn.addEventListener('click', showStartScreen);
            if (saveScoreBtn) saveScoreBtn.addEventListener('click', saveScore);
            if (resumeBtn) resumeBtn.addEventListener('click', resumeGame);
            if (restartBtn) restartBtn.addEventListener('click', startGame);
            if (quitToMenuBtn) quitToMenuBtn.addEventListener('click', showStartScreen);

            canvas.addEventListener('mousemove', handleMouseMove);
            canvas.addEventListener('click', firePlayerBullet);
            window.addEventListener('keydown', handleKeyDown);
            window.addEventListener('keydown', handlePause);
            if (isMobile) setupMobileControls();
            window.addEventListener('resize', handleResize);
        }

        function setupMobileControls() {
    const joystickMaxDistance = 50; // Maximum distance the joystick thumb can move
    let joystickTouchId = null; // Track the specific touch for joystick
    let fireTouchId = null; // Track the specific touch for fire button

    // Joystick touch start
    joystickArea.addEventListener('touchstart', (e) => {
        e.preventDefault();
        if (!joystickTouchId) {
            const touch = e.changedTouches[0];
            joystickTouchId = touch.identifier;
            isJoystickActive = true;
            const now = Date.now();
            if (now - lastJoystickTap < 300) {
                performDash();
                if (navigator.vibrate) navigator.vibrate(50);
            }
            lastJoystickTap = now;
            updateJoystickPosition(touch);
        }
    }, { passive: false });

    // Fire button touch start
    fireBtn.addEventListener('touchstart', (e) => {
        e.preventDefault();
        if (!fireTouchId) {
            const touch = e.changedTouches[0];
            fireTouchId = touch.identifier;
            isFireBtnActive = true;
            if (gameRunning) {
                firePlayerBullet();
                if (autoFireInterval === null) {
                    autoFireInterval = setInterval(() => {
                        if (isFireBtnActive && gameRunning) firePlayerBullet();
                    }, player.shootDelay);
                }
            }
        }
    }, { passive: false });

    // Touch move for joystick
    document.addEventListener('touchmove', (e) => {
        e.preventDefault();
        for (let i = 0; i < e.touches.length; i++) {
            const touch = e.touches[i];
            if (touch.identifier === joystickTouchId && isJoystickActive && gameRunning) {
                updateJoystickPosition(touch);
            }
        }
    }, { passive: false });

    // Touch end for joystick
    document.addEventListener('touchend', (e) => {
        e.preventDefault();
        for (let i = 0; i < e.changedTouches.length; i++) {
            const touch = e.changedTouches[i];
            if (touch.identifier === joystickTouchId) {
                isJoystickActive = false;
                joystickTouchId = null;
                resetJoystick();
            }
            if (touch.identifier === fireTouchId) {
                isFireBtnActive = false;
                fireTouchId = null;
                if (autoFireInterval !== null) {
                    clearInterval(autoFireInterval);
                    autoFireInterval = null;
                }
            }
        }
    }, { passive: false });

    // Touch cancel (e.g., interrupted by system)
    document.addEventListener('touchcancel', (e) => {
        e.preventDefault();
        for (let i = 0; i < e.changedTouches.length; i++) {
            const touch = e.changedTouches[i];
            if (touch.identifier === joystickTouchId) {
                isJoystickActive = false;
                joystickTouchId = null;
                resetJoystick();
            }
            if (touch.identifier === fireTouchId) {
                isFireBtnActive = false;
                fireTouchId = null;
                if (autoFireInterval !== null) {
                    clearInterval(autoFireInterval);
                    autoFireInterval = null;
                }
            }
        }
    }, { passive: false });

    function updateJoystickPosition(touch) {
        const joystickRect = joystickArea.getBoundingClientRect();
        const centerX = joystickRect.left + joystickRect.width / 2;
        const centerY = joystickRect.top + joystickRect.height / 2;
        const deltaX = touch.clientX - centerX;
        const deltaY = touch.clientY - centerY;
        const distance = Math.sqrt(deltaX * deltaX + deltaY * deltaY);
        const limitedDistance = Math.min(distance, joystickMaxDistance);
        const angle = Math.atan2(deltaY, deltaX);

        const limitedX = Math.cos(angle) * limitedDistance;
        const limitedY = Math.sin(angle) * limitedDistance;

        joystickThumb.style.transform = `translate(${limitedX}px, ${limitedY}px)`;
        player.velocityX = (limitedX / joystickMaxDistance) * player.speed;
        player.velocityY = (limitedY / joystickMaxDistance) * player.speed;
    }

    function resetJoystick() {
        joystickThumb.style.transform = 'translate(-50%, -50%)';
        player.velocityX = 0;
        player.velocityY = 0;
    }
}
        function handleResize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            if (player.x > canvas.width - player.width) player.x = canvas.width - player.width;
            if (player.y > canvas.height - player.height) player.y = canvas.height - player.height;
            if (player.y < 0) player.y = 0;
            initBackgroundStars();
        }

        function handleMouseMove(e) {
            if (gameRunning && !isMobile && !isPaused) {
                player.x = e.clientX - player.width / 2;
                player.y = e.clientY - player.height / 2;
                if (player.x < 0) player.x = 0;
                if (player.x > canvas.width - player.width) player.x = canvas.width - player.width;
                if (player.y < 0) player.y = 0;
                if (player.y > canvas.height - player.height) player.y = canvas.height - player.height;
            }
        }

        function handleKeyDown(e) {
            if (gameRunning && e.code === 'Space' && !isPaused) firePlayerBullet();
            if (gameRunning && e.code === 'ShiftLeft' && !isPaused) performDash();
        }

        function handlePause(e) {
            if (e.code === 'Escape' && gameRunning) togglePause();
        }

        function togglePause() {
            if (!isPaused) {
                isPaused = true;
                pauseScreen.style.opacity = '0';
                pauseScreen.style.display = 'flex';
                setTimeout(() => pauseScreen.style.opacity = '1', 10);
                cancelAnimationFrame(animationFrameId);
                backgroundMusic.pause();
                bossMusic.pause();
                canvas.style.cursor = 'default';
            } else {
                resumeGame();
            }
        }

        function resumeGame() {
            isPaused = false;
            pauseScreen.style.opacity = '0';
            setTimeout(() => pauseScreen.style.display = 'none', 500);
            lastTime = performance.now();
            if (soundOn) {
                if (bossActive) bossMusic.play();
                else backgroundMusic.play();
            }
            canvas.style.cursor = isMobile ? 'default' : 'none';
            if (gameRunning) animationFrameId = requestAnimationFrame(gameLoop);
        }

        function performDash() {
            const now = Date.now();
            if (now - player.lastDash >= player.dashCooldown) {
                const directionX = player.velocityX !== 0 ? player.velocityX / Math.abs(player.velocityX) : 0;
                const directionY = player.velocityY !== 0 ? player.velocityY / Math.abs(player.velocityY) : 0;
                player.x += directionX * player.dashDistance;
                player.y += directionY * player.dashDistance;
                player.x = Math.max(0, Math.min(canvas.width - player.width, player.x));
                player.y = Math.max(0, Math.min(canvas.height - player.height, player.y));
                player.lastDash = now;
                playSound('dash');
                // Add dash particles
                for (let i = 0; i < 10; i++) {
                    particles.push({
                        x: player.x + player.width / 2,
                        y: player.y + player.height,
                        radius: Math.random() * 2 + 1,
                        color: '#0f0',
                        speedX: (Math.random() - 0.5) * 4,
                        speedY: (Math.random() - 0.5) * 4,
                        life: 20
                    });
                }
            }
        }

        function firePlayerBullet() {
            const now = Date.now();
            if (gameRunning && !isPaused && now - player.lastShot > player.shootDelay) {
                let bulletCount = 1;
                let angles = [0];
                if (player.weaponType === 'spread') {
                    bulletCount = 5; // Increased spread bullets
                    angles = [-0.3, -0.15, 0, 0.15, 0.3];
                } else if (player.weaponType === 'laser') {
                    bulletCount = 1;
                } else if (player.weaponType === 'homing') {
                    bulletCount = 1;
                }
                
                for (let i = 0; i < bulletCount; i++) {
                    const bullet = player.bulletPool.find(b => !b.active);
                    if (bullet) {
                        bullet.active = true;
                        bullet.x = player.x + player.width / 2 - 2;
                        bullet.y = player.y;
                        bullet.width = player.weaponType === 'laser' ? 8 : 4;
                        bullet.height = player.weaponType === 'laser' ? 20 : 10;
                        bullet.speed = player.weaponType === 'laser' ? 18 : 12;
                        bullet.angle = angles[i] || 0;
                    }
                }
                player.lastShot = now;
                player.fireAnimation = 8;
                playSound('laser', 0.9 + Math.random() * 0.2);
            }
        }

        function startGame() {
            const difficultySetting = document.getElementById('difficulty-setting');
            difficulty = difficultySetting ? difficultySetting.value : 'normal';
            startScreen.style.opacity = '0';
            setTimeout(() => startScreen.style.display = 'none', 500);
            gameOverScreen.style.display = 'none';
            highScoreScreen.style.display = 'none';
            howToPlayScreen.style.display = 'none';
            pauseScreen.style.display = 'none';
            settingsScreen.style.display = 'none';
            score = 0;
            lives = 3;
            combo = 0;
            comboMultiplier = 1;
            enemySpeedMultiplier = difficulty === 'easy' ? 0.7 : difficulty === 'hard' ? 1.3 : 1;
            enemySpawnRate = difficulty === 'easy' ? 1200 : difficulty === 'hard' ? 800 : 1000;
            shieldActive = false;
            shieldTime = 0;
            bossActive = false;
            lastBossScore = -5000;
            enemies = [];
            powerUps = [];
            explosions = [];
            particles = [];
            player.bullets = [];
            player.bulletPool.forEach(b => b.active = false);
            enemyPool.forEach(e => e.active = false);
            enemyBulletPool.forEach(b => b.active = false);
            player.x = canvas.width / 2 - player.width / 2;
            player.y = canvas.height - player.height - 20;
            player.weaponType = 'default';
            player.weaponTime = 0;
            isJoystickActive = false;
            isFireBtnActive = false;
            if (autoFireInterval !== null) {
                clearInterval(autoFireInterval);
                autoFireInterval = null;
            }
            updateScoreDisplay();
            updateComboDisplay();
            if (isMobile) mobileControls.style.display = 'block';
            gameRunning = true;
            isPaused = false;
            lastTime = performance.now();
            playSound('game-start');
            if (soundOn) backgroundMusic.play().catch(error => console.log('Background music failed:', error));
            canvas.style.cursor = isMobile ? 'default' : 'none';
            animationFrameId = requestAnimationFrame(gameLoop);
        }

        function gameLoop(timestamp) {
            if (isPaused) return;

            const deltaTime = Math.min((timestamp - lastTime) / 1000, 0.1);
            lastTime = timestamp;

            enemySpeedMultiplier = difficulty === 'easy' ? 0.7 + score / 6000 : difficulty === 'hard' ? 1.3 + score / 2500 : 1 + score / 4000;
            if (Date.now() - lastKillTime > 3000) {
                combo = 0;
                comboMultiplier = 1;
                updateComboDisplay();
            }
            if (shieldActive) {
                shieldTime -= deltaTime * 1000;
                if (shieldTime <= 0) shieldActive = false;
            }
            if (player.weaponType !== 'default') {
                player.weaponTime -= deltaTime * 1000;
                if (player.weaponTime <= 0) player.weaponType = 'default';
            }
            if (screenShake > 0) screenShake = Math.max(0, screenShake - deltaTime * 10);

            ctx.save();
            if (screenShake > 0) ctx.translate(Math.random() * screenShake - screenShake / 2, Math.random() * screenShake - screenShake / 2);
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            drawBackground();
            if (timestamp - lastEnemySpawn > enemySpawnRate / enemySpeedMultiplier && !bossActive) {
                if (score >= lastBossScore + 5000 && score >= 5000) {
                    spawnBoss();
                    lastBossScore = Math.floor(score / 5000) * 5000;
                } else {
                    spawnEnemy();
                }
                if (Math.random() < 0.2) spawnPowerUp(); // Increased power-up spawn chance
                lastEnemySpawn = timestamp;
            }
            updatePlayer(deltaTime);
            drawPlayer();
            updatePlayerBullets(deltaTime);
            updateEnemies(deltaTime);
            updatePowerUps(deltaTime);
            updateExplosions(deltaTime);
            updateParticles(deltaTime);
            checkCollisions();
            ctx.restore();

            if (gameRunning) animationFrameId = requestAnimationFrame(gameLoop);
        }

        function drawBackground() {
            const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
            gradient.addColorStop(0, '#000033');
            gradient.addColorStop(1, '#000066');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            ctx.fillStyle = 'rgba(255, 255, 255, 0.6)';
            backgroundStarsSlow.forEach(star => {
                star.y += star.speed * enemySpeedMultiplier * 0.5;
                if (star.y > canvas.height) star.y = -star.size;
                ctx.fillRect(star.x, star.y, star.size, star.size);
            });

            ctx.fillStyle = 'white';
            backgroundStarsFast.forEach(star => {
                star.y += star.speed * enemySpeedMultiplier;
                if (star.y > canvas.height) star.y = -star.size;
                ctx.fillRect(star.x, star.y, star.size, star.size);
            });
        }

        function updatePlayer(deltaTime) {
            player.x += player.velocityX * deltaTime * 60;
            player.y += player.velocityY * deltaTime * 60;
            
            if (player.x < 0) player.x = 0;
            if (player.x > canvas.width - player.width) player.x = canvas.width - player.width;
            if (player.y < 0) player.y = 0;
            if (player.y > canvas.height - player.height) player.y = canvas.height - player.height;

            if (!isJoystickActive && Math.abs(player.velocityX) > 0.1) player.velocityX *= 0.95;
            if (!isJoystickActive && Math.abs(player.velocityY) > 0.1) player.velocityY *= 0.95;
            if (!isJoystickActive && Math.abs(player.velocityX) <= 0.1) player.velocityX = 0;
            if (!isJoystickActive && Math.abs(player.velocityY) <= 0.1) player.velocityY = 0;

            if (player.fireAnimation > 0) player.fireAnimation--;
            player.boosterAnimation = 1;
        }

        function drawPlayer() {
            ctx.fillStyle = playerColors[playerColorIndex].value;
            ctx.beginPath();
            ctx.moveTo(player.x + player.width / 2, player.y);
            ctx.lineTo(player.x + player.width, player.y + player.height * 0.8);
            ctx.lineTo(player.x + player.width * 0.7, player.y + player.height);
            ctx.lineTo(player.x + player.width * 0.3, player.y + player.height);
            ctx.lineTo(player.x, player.y + player.height * 0.8);
            ctx.closePath();
            ctx.fill();

            ctx.fillStyle = 'rgba(255, 165, 0, 1)';
            ctx.beginPath();
            ctx.moveTo(player.x + player.width / 2 - 10, player.y + player.height);
            ctx.lineTo(player.x + player.width / 2, player.y + player.height + 15);
            ctx.lineTo(player.x + player.width / 2 + 10, player.y + player.height);
            ctx.closePath();
            ctx.fill();

            if (player.fireAnimation > 0) {
                ctx.fillStyle = `rgba(255, 165, 0, ${player.fireAnimation / 8})`;
                ctx.beginPath();
                ctx.arc(player.x + player.width / 2, player.y - 5, 10 * (player.fireAnimation / 8), 0, Math.PI * 2);
                ctx.fill();
            }

            if (shieldActive) {
                ctx.strokeStyle = `rgba(0, 191, 255, ${0.5 + Math.sin(Date.now() / 200) * 0.3})`;
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.arc(player.x + player.width / 2, player.y + player.height / 2, player.width, 0, Math.PI * 2);
                ctx.stroke();
            }
        }

        function updatePlayerBullets(deltaTime) {
            player.bulletPool.forEach(bullet => {
                if (!bullet.active) return;
                if (bullet.angle) {
                    bullet.x += Math.sin(bullet.angle) * bullet.speed * deltaTime * 60;
                    bullet.y -= Math.cos(bullet.angle) * bullet.speed * deltaTime * 60;
                } else if (player.weaponType === 'homing') {
                    let closestEnemy = null;
                    let minDist = Infinity;
                    enemyPool.forEach(enemy => {
                        if (!enemy.active) return;
                        const dist = Math.hypot(enemy.x + enemy.width / 2 - bullet.x, enemy.y + enemy.height / 2 - bullet.y);
                        if (dist < minDist) {
                            minDist = dist;
                            closestEnemy = enemy;
                        }
                    });
                    if (closestEnemy) {
                        const dx = (closestEnemy.x + closestEnemy.width / 2) - bullet.x;
                        const dy = (closestEnemy.y + closestEnemy.height / 2) - bullet.y;
                        const angle = Math.atan2(dy, dx);
                        bullet.x += Math.cos(angle) * bullet.speed * deltaTime * 60;
                        bullet.y += Math.sin(angle) * bullet.speed * deltaTime * 60;
                    } else {
                        bullet.y -= bullet.speed * deltaTime * 60;
                    }
                } else {
                    bullet.y -= bullet.speed * deltaTime * 60;
                }
                if (bullet.y < -bullet.height) {
                    bullet.active = false;
                    return;
                }
                ctx.fillStyle = player.weaponType === 'laser' ? '#ff0000' : player.weaponType === 'homing' ? '#0ff' : '#0f0';
                ctx.fillRect(bullet.x, bullet.y, bullet.width, bullet.height);
            });
        }

        function spawnEnemy() {
            const enemyTypes = [
                { width: 40, height: 40, speed: 1.8, health: 1, color: '#f00', shootRate: 1800, type: 'basic' },      // Red
                { width: 30, height: 30, speed: 3, health: 1, color: '#ff0', shootRate: 2200, type: 'scout' },       // Yellow
                { width: 50, height: 50, speed: 1.2, health: 2, color: '#f0f', shootRate: 2800, type: 'kamikaze' },  // Purple
                { width: 60, height: 60, speed: 1, health: 4, color: '#00f', shootRate: 1300, type: 'shielded' }     // Blue
            ];
            const type = enemyTypes[Math.floor(Math.random() * enemyTypes.length)];
            const enemy = enemyPool.find(e => !e.active);
            if (enemy) {
                enemy.active = true;
                enemy.x = Math.random() * (canvas.width - type.width);
                enemy.y = -type.height;
                enemy.width = type.width;
                enemy.height = type.height;
                enemy.speed = type.speed * enemySpeedMultiplier;
                enemy.health = type.health;
                enemy.maxHealth = type.health;
                enemy.color = type.color;
                enemy.shootRate = Math.max(800, type.shootRate - Math.floor(score / 15));
                enemy.type = type.type;
                enemy.bullets = [];
                enemy.lastShot = 0;
            }
        }

        function spawnBoss() {
            bossActive = true;
            const boss = enemyPool.find(e => !e.active);
            if (boss) {
                boss.active = true;
                boss.x = canvas.width / 2 - 100;
                boss.y = -200;
                boss.width = 200;
                boss.height = 200;
                boss.speed = 0.6 * enemySpeedMultiplier;
                boss.bullets = [];
                boss.lastShot = 0;
                boss.shootRate = 400; // Faster shooting
                boss.health = 25; // Increased health
                boss.maxHealth = 25;
                boss.color = '#ff4500';
                boss.type = 'boss';
                boss.phase = 0;
            }
            if (soundOn) {
                backgroundMusic.pause();
                bossMusic.play().catch(error => console.log('Boss music failed:', error));
            }
        }

        function updateEnemies(deltaTime) {
            enemyPool.forEach(enemy => {
                if (!enemy.active) return;
                enemy.y += enemy.speed * deltaTime * 60;

                if (enemy.y > canvas.height) {
                    enemy.active = false;
                    if (enemy.type === 'boss') {
                        bossActive = false;
                        if (soundOn) {
                            bossMusic.pause();
                            backgroundMusic.play();
                        }
                    }
                    return;
                }

                if (enemy.shootRate > 0 && Date.now() - enemy.lastShot > enemy.shootRate) {
                    if (enemy.type === 'boss') {
                        if (enemy.phase === 0) {
                            for (let j = -2; j <= 2; j++) spawnEnemyBullet(enemy, j * 0.3);
                            if (enemy.health < 18) enemy.phase = 1;
                        } else if (enemy.phase === 1) {
                            spawnEnemyBullet(enemy, 0, 20, 20, 5);
                            if (enemy.health < 10) enemy.phase = 2;
                        } else {
                            for (let j = 0; j < 4; j++) spawnEnemyBullet(enemy, (Math.random() - 0.5) * 0.6);
                        }
                    } else {
                        spawnEnemyBullet(enemy);
                    }
                    enemy.lastShot = Date.now();
                    enemy.fireAnimation = 8;
                }

                if (enemy.fireAnimation > 0) enemy.fireAnimation--;
                enemy.boosterAnimation = 1;

                ctx.fillStyle = enemy.color;
                ctx.beginPath();
                if (enemy.type === 'boss') {
                    ctx.moveTo(enemy.x + enemy.width / 2, enemy.y);
                    ctx.lineTo(enemy.x + enemy.width, enemy.y + enemy.height * 0.8);
                    ctx.lineTo(enemy.x + enemy.width * 0.7, enemy.y + enemy.height);
                    ctx.lineTo(enemy.x + enemy.width * 0.3, enemy.y + enemy.height);
                    ctx.lineTo(enemy.x, enemy.y + enemy.height * 0.8);
                } else {
                    ctx.moveTo(enemy.x, enemy.y);
                    ctx.lineTo(enemy.x + enemy.width, enemy.y);
                    ctx.lineTo(enemy.x + enemy.width / 2, enemy.y + enemy.height);
                }
                ctx.closePath();
                ctx.fill();

                if (enemy.health < enemy.maxHealth) {
                    ctx.fillStyle = '#ff0000';
                    ctx.fillRect(enemy.x, enemy.y - 10, enemy.width * (enemy.health / enemy.maxHealth), 5);
                    ctx.strokeStyle = '#fff';
                    ctx.strokeRect(enemy.x, enemy.y - 10, enemy.width, 5);
                }

                ctx.fillStyle = `rgba(255, 165, 0, ${enemy.boosterAnimation})`;
                ctx.beginPath();
                ctx.moveTo(enemy.x + enemy.width / 2 - 5, enemy.y);
                ctx.lineTo(enemy.x + enemy.width / 2, enemy.y - 10 * enemy.boosterAnimation);
                ctx.lineTo(enemy.x + enemy.width / 2 + 5, enemy.y);
                ctx.closePath();
                ctx.fill();

                if (enemy.fireAnimation > 0) {
                    ctx.fillStyle = `rgba(255, 0, 0, ${enemy.fireAnimation / 8})`;
                    ctx.beginPath();
                    ctx.arc(enemy.x + enemy.width / 2, enemy.y + enemy.height + 5, 10 * (enemy.fireAnimation / 8), 0, Math.PI * 2);
                    ctx.fill();
                }
            });

            enemyBulletPool.forEach(bullet => {
                if (!bullet.active) return;
                if (bullet.angle) {
                    bullet.x += Math.sin(bullet.angle) * bullet.speed * deltaTime * 60;
                    bullet.y += Math.cos(bullet.angle) * bullet.speed * deltaTime * 60;
                } else {
                    bullet.y += bullet.speed * deltaTime * 60;
                }
                if (bullet.y > canvas.height || bullet.y < -bullet.height || bullet.x < -bullet.width || bullet.x > canvas.width) {
                    bullet.active = false;
                    return;
                }
                ctx.fillStyle = bullet.width > 4 ? '#ff4500' : '#f00';
                ctx.fillRect(bullet.x, bullet.y, bullet.width, bullet.height);
            });
        }

        function spawnEnemyBullet(enemy, angle = 0, width = 4, height = 10, speed = 6) {
            const bullet = enemyBulletPool.find(b => !b.active);
            if (bullet) {
                bullet.active = true;
                bullet.x = enemy.x + enemy.width / 2 - width / 2;
                bullet.y = enemy.y + enemy.height;
                bullet.width = width;
                bullet.height = height;
                bullet.speed = speed;
                bullet.angle = angle;
            }
        }

        function spawnPowerUp() {
            const x = Math.random() * (canvas.width - 20);
            const types = [
                { color: '#ff0', effect: 'speed' },
                { color: '#00f', effect: 'shield' },
                { color: '#f0f', effect: 'spread' },
                { color: '#f00', effect: 'laser' },
                { color: '#0ff', effect: 'homing' },
                { color: '#fff', effect: 'invincibility' },
                { color: '#ffd700', effect: 'score_boost' } // New power-up: score multiplier
            ];
            const type = types[Math.floor(Math.random() * types.length)];
            powerUps.push({
                x: x,
                y: -20,
                width: 20,
                height: 20,
                speed: 3, // Slightly faster power-ups
                color: type.color,
                effect: type.effect
            });
        }

        function updatePowerUps(deltaTime) {
            for (let i = powerUps.length - 1; i >= 0; i--) {
                const powerUp = powerUps[i];
                powerUp.y += powerUp.speed * deltaTime * 60;
                if (powerUp.y > canvas.height) {
                    powerUps.splice(i, 1);
                    continue;
                }
                ctx.fillStyle = powerUp.color;
                ctx.fillRect(powerUp.x, powerUp.y, powerUp.width, powerUp.height);
                
                if (Math.random() < 0.3) {
                    particles.push({
                        x: powerUp.x + powerUp.width / 2,
                        y: powerUp.y + powerUp.height / 2,
                        radius: Math.random() * 2 + 1,
                        color: powerUp.color,
                        speedX: (Math.random() - 0.5) * 2,
                        speedY: (Math.random() - 0.5) * 2,
                        life: 30
                    });
                }
            }
        }

        function updateExplosions(deltaTime) {
            for (let i = explosions.length - 1; i >= 0; i--) {
                const explosion = explosions[i];
                explosion.radius += 0.6 * deltaTime * 60;
                explosion.opacity -= 0.05 * deltaTime * 60;
                explosion.stage = explosion.stage || 0;
                explosion.stage += deltaTime * 60;
                if (explosion.opacity <= 0) {
                    explosions.splice(i, 1);
                    continue;
                }
                ctx.fillStyle = explosion.stage < 5 ? '#ffffff' : `rgba(255, 165, 0, ${explosion.opacity})`;
                ctx.beginPath();
                ctx.arc(explosion.x, explosion.y, explosion.radius, 0, Math.PI * 2);
                ctx.fill();
            }
        }

        function updateParticles(deltaTime) {
            for (let i = particles.length - 1; i >= 0; i--) {
                const particle = particles[i];
                particle.x += particle.speedX;
                particle.y += particle.speedY;
                particle.life -= deltaTime * 60;
                if (particle.life <= 0) {
                    particles.splice(i, 1);
                    continue;
                }
                ctx.fillStyle = `rgba(${parseInt(particle.color.slice(1, 3), 16)}, ${parseInt(particle.color.slice(3, 5), 16)}, ${parseInt(particle.color.slice(5, 7), 16)}, ${particle.life / 30})`;
                ctx.beginPath();
                ctx.arc(particle.x, particle.y, particle.radius, 0, Math.PI * 2);
                ctx.fill();
            }
        }

        function checkCollisions() {
            player.bulletPool.forEach(bullet => {
                if (!bullet.active) return;
                for (let j = enemyPool.length - 1; j >= 0; j--) {
                    const enemy = enemyPool[j];
                    if (!enemy.active) continue;
                    if (checkCollision(bullet, enemy)) {
                        bullet.active = false;
                        enemy.health--;
                        playSound('hit');
                        if (navigator.vibrate) navigator.vibrate(20);
                        if (enemy.health <= 0) {
                            enemy.active = false;
                            if (enemy.type === 'boss') {
                                bossActive = false;
                                if (soundOn) {
                                    bossMusic.pause();
                                    backgroundMusic.play();
                                }
                            }
                            explosions.push({
                                x: enemy.x + enemy.width / 2,
                                y: enemy.y + enemy.height / 2,
                                radius: enemy.type === 'boss' ? 25 : 8,
                                opacity: 1
                            });
                            for (let k = 0; k < (enemy.type === 'boss' ? 25 : 15); k++) {
                                particles.push({
                                    x: enemy.x + enemy.width / 2,
                                    y: enemy.y + enemy.height / 2,
                                    radius: Math.random() * 3 + 1,
                                    color: enemy.color,
                                    speedX: (Math.random() - 0.5) * 6,
                                    speedY: (Math.random() - 0.5) * 6,
                                    life: 35
                                });
                            }
                            combo++;
                            const oldMultiplier = comboMultiplier;
                            comboMultiplier = Math.min(6, 1 + Math.floor(combo / 2)); // Increased max multiplier
                            lastKillTime = Date.now();
                            score += Math.floor(15 * enemySpeedMultiplier * comboMultiplier * (enemy.type === 'boss' ? 15 : 1)); // Increased base points
                            playSound('explosion');
                            if (comboMultiplier > oldMultiplier) playSound('combo');
                            updateComboDisplay();
                        }
                        updateScoreDisplay();
                        break;
                    }
                }
            });

            for (let i = enemyPool.length - 1; i >= 0; i--) {
                const enemy = enemyPool[i];
                if (!enemy.active) continue;
                if (checkCollision(player, enemy)) {
                    if (!shieldActive) loseLife();
                    enemy.active = false;
                    if (enemy.type === 'boss') {
                        bossActive = false;
                        if (soundOn) {
                            bossMusic.pause();
                            backgroundMusic.play();
                        }
                    }
                    explosions.push({
                        x: enemy.x + enemy.width / 2,
                        y: enemy.y + enemy.height / 2,
                        radius: 8,
                        opacity: 1
                    });
                    playSound('explosion');
                    return;
                }
                enemyBulletPool.forEach(bullet => {
                    if (!bullet.active) return;
                    if (checkCollision(bullet, player)) {
                        bullet.active = false;
                        if (!shieldActive) loseLife();
                        return;
                    }
                });
            }

            for (let i = powerUps.length - 1; i >= 0; i--) {
                const powerUp = powerUps[i];
                if (checkCollision(player, powerUp)) {
                    powerUps.splice(i, 1);
                    if (powerUp.effect === 'speed') {
                        player.shootDelay = Math.max(80, player.shootDelay - 40);
                        score += 75;
                    } else if (powerUp.effect === 'shield') {
                        shieldActive = true;
                        shieldTime = 6000; // Increased duration
                        score += 75;
                    } else if (powerUp.effect === 'spread') {
                        player.weaponType = 'spread';
                        player.weaponTime = 12000; // Increased duration
                        score += 75;
                    } else if (powerUp.effect === 'laser') {
                        player.weaponType = 'laser';
                        player.weaponTime = 12000;
                        score += 75;
                    } else if (powerUp.effect === 'homing') {
                        player.weaponType = 'homing';
                        player.weaponTime = 12000;
                        score += 75;
                    } else if (powerUp.effect === 'invincibility') {
                        shieldActive = true;
                        shieldTime = 12000;
                        score += 75;
                    } else if (powerUp.effect === 'score_boost') {
                        score += 200; // New power-up effect
                        comboMultiplier = Math.min(6, comboMultiplier + 1);
                        updateComboDisplay();
                    }
                    updateScoreDisplay();
                    playSound('powerup');
                }
            }
        }

        function checkCollision(a, b) {
            return a.x < b.x + b.width &&
                   a.x + a.width > b.x &&
                   a.y < b.y + b.height &&
                   a.y + a.height > b.y;
        }

        function loseLife() {
            lives--;
            combo = 0;
            comboMultiplier = 1;
            screenShake = 12;
            updateScoreDisplay();
            updateComboDisplay();
            if (lives <= 0) {
                gameOver();
            } else {
                player.x = canvas.width / 2 - player.width / 2;
                player.y = canvas.height - player.height - 20;
                playSound('hit');
                if (navigator.vibrate) navigator.vibrate(100);
            }
        }

        function gameOver() {
            gameRunning = false;
            cancelAnimationFrame(animationFrameId);
            if (autoFireInterval !== null) {
                clearInterval(autoFireInterval);
                autoFireInterval = null;
            }
            finalScoreDisplay.textContent = `Your score: ${Math.floor(score)}`;
            gameOverScreen.style.opacity = '0';
            gameOverScreen.style.display = 'flex';
            setTimeout(() => gameOverScreen.style.opacity = '1', 10);
            if (isMobile) mobileControls.style.display = 'none';
            backgroundMusic.pause();
            bossMusic.pause();
            backgroundMusic.currentTime = 0;
            bossMusic.currentTime = 0;
            playSound('gameover');
            canvas.style.cursor = 'default';
        }

        function saveScore() {
            const playerName = document.getElementById('player-name').value.trim() || 'Anonymous';
            highScores.push({ name: playerName, score: Math.floor(score) });
            highScores.sort((a, b) => b.score - a.score);
            if (highScores.length > 10) highScores.length = 10;
            localStorage.setItem('spaceShooterHighScores', JSON.stringify(highScores));
            showHighScores();
        }

        function showHighScores() {
            startScreen.style.opacity = '0';
            setTimeout(() => startScreen.style.display = 'none', 500);
            gameOverScreen.style.display = 'none';
            howToPlayScreen.style.display = 'none';
            pauseScreen.style.display = 'none';
            settingsScreen.style.display = 'none';
            highScoreScreen.style.opacity = '0';
            highScoreScreen.style.display = 'flex';
            setTimeout(() => highScoreScreen.style.opacity = '1', 10);
            const highScoresBody = document.getElementById('high-scores-body');
            highScoresBody.innerHTML = '';
            highScores.forEach((entry, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `<td>${index + 1}</td><td>${entry.name}</td><td>${Math.floor(entry.score)}</td>`;
                highScoresBody.appendChild(row);
            });
            document.getElementById('reset-scores-btn').addEventListener('click', () => {
                highScores = [];
                localStorage.setItem('spaceShooterHighScores', JSON.stringify(highScores));
                alert('High scores reset!');
                showHighScores();
            });
            if (isMobile) mobileControls.style.display = 'none';
            backgroundMusic.pause();
            bossMusic.pause();
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            canvas.style.cursor = 'default';
        }

        function showHowToPlay() {
            startScreen.style.opacity = '0';
            setTimeout(() => startScreen.style.display = 'none', 500);
            gameOverScreen.style.display = 'none';
            highScoreScreen.style.display = 'none';
            pauseScreen.style.display = 'none';
            settingsScreen.style.display = 'none';
            howToPlayScreen.style.opacity = '0';
            howToPlayScreen.style.display = 'flex';
            setTimeout(() => howToPlayScreen.style.opacity = '1', 10);
            if (isMobile) mobileControls.style.display = 'none';
            backgroundMusic.pause();
            bossMusic.pause();
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            canvas.style.cursor = 'default';
        }

        function showSettings() {
            startScreen.style.opacity = '0';
            setTimeout(() => startScreen.style.display = 'none', 500);
            gameOverScreen.style.display = 'none';
            highScoreScreen.style.display = 'none';
            howToPlayScreen.style.display = 'none';
            pauseScreen.style.display = 'none';
            settingsScreen.style.opacity = '0';
            settingsScreen.style.display = 'flex';
            setTimeout(() => settingsScreen.style.opacity = '1', 10);
            if (isMobile) mobileControls.style.display = 'none';
            backgroundMusic.pause();
            bossMusic.pause();
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            canvas.style.cursor = 'default';

            settingsScreen.innerHTML = `
                <h2>SETTINGS</h2>
                <div class="settings-container">
                    <label for="difficulty-setting" style="display: block; margin-bottom: 10px;">Difficulty:</label>
                    <select id="difficulty-setting">
                        <option value="easy">Easy</option>
                        <option value="normal" selected>Normal</option>
                        <option value="hard">Hard</option>
                    </select>

                    <label for="volume-slider" style="display: block; margin: 20px 0 10px;">Volume:</label>
                    <input type="range" id="volume-slider" min="0" max="1" step="0.1" value="${backgroundMusic.volume}">

                    <label style="display: block; margin: 20px 0 10px;">Spaceship Color:</label>
                    <div class="color-selector">
                        <button class="arrow-btn" id="color-left-btn">←</button>
                        <div class="color-preview"><canvas id="color-preview-canvas" class="color-preview-canvas"></canvas></div>
                        <button class="arrow-btn" id="color-right-btn">→</button>
                    </div>

                    <label for="sound-toggle" style="display: block; margin: 20px 0 10px;">Sound:</label>
                    <button id="sound-toggle" data-sound="${soundOn ? 'on' : 'off'}">${soundOn ? 'ON' : 'OFF'}</button>
                </div>
                <button id="back-from-settings-btn">BACK</button>
            `;
            document.getElementById('difficulty-setting').value = difficulty;
            document.getElementById('color-left-btn').addEventListener('click', () => {
                playerColorIndex = (playerColorIndex - 1 + playerColors.length) % playerColors.length;
                updateColorPreview();
            });
            document.getElementById('color-right-btn').addEventListener('click', () => {
                playerColorIndex = (playerColorIndex + 1) % playerColors.length;
                updateColorPreview();
            });
            document.getElementById('sound-toggle').addEventListener('click', toggleSound);
            document.getElementById('back-from-settings-btn').addEventListener('click', showStartScreen);
            document.getElementById('volume-slider').addEventListener('input', () => {
                backgroundMusic.volume = document.getElementById('volume-slider').value;
                bossMusic.volume = document.getElementById('volume-slider').value;
            });

            updateColorPreview();
        }

        function updateColorPreview() {
            const previewCanvas = document.getElementById('color-preview-canvas');
            const previewCtx = previewCanvas.getContext('2d');
            previewCanvas.width = 80;
            previewCanvas.height = 100;

            previewCtx.clearRect(0, 0, previewCanvas.width, previewCanvas.height);

            previewCtx.fillStyle = playerColors[playerColorIndex].value;
            previewCtx.beginPath();
            previewCtx.moveTo(previewCanvas.width / 2, 10);
            previewCtx.lineTo(previewCanvas.width - 10, 10 + 40 * 0.8);
            previewCtx.lineTo(previewCanvas.width * 0.7, 10 + 40);
            previewCtx.lineTo(previewCanvas.width * 0.3, 10 + 40);
            previewCtx.lineTo(10, 10 + 40 * 0.8);
            previewCtx.closePath();
            previewCtx.fill();

            previewCtx.fillStyle = 'rgba(255, 165, 0, 1)';
            previewCtx.beginPath();
            previewCtx.moveTo(previewCanvas.width / 2 - 10, 10 + 40);
            previewCtx.lineTo(previewCanvas.width / 2, 10 + 55);
            previewCtx.lineTo(previewCanvas.width / 2 + 10, 10 + 40);
            previewCtx.closePath();
            previewCtx.fill();

            const previewDiv = document.querySelector('.color-preview');
            previewDiv.style.transform = 'scale(1.1)';
            setTimeout(() => previewDiv.style.transform = 'scale(1)', 200);
        }

        function toggleSound() {
            soundOn = !soundOn;
            const soundToggle = document.getElementById('sound-toggle');
            soundToggle.textContent = soundOn ? 'ON' : 'OFF';
            soundToggle.setAttribute('data-sound', soundOn ? 'on' : 'off');
            if (!soundOn) {
                backgroundMusic.pause();
                bossMusic.pause();
            } else if (gameRunning && !isPaused) {
                if (bossActive) bossMusic.play();
                else backgroundMusic.play();
            }
        }

        function showStartScreen() {
            startScreen.style.opacity = '0';
            startScreen.style.display = 'flex';
            setTimeout(() => startScreen.style.opacity = '1', 10);
            gameOverScreen.style.display = 'none';
            highScoreScreen.style.display = 'none';
            howToPlayScreen.style.display = 'none';
            pauseScreen.style.display = 'none';
            settingsScreen.style.display = 'none';
            if (isMobile) mobileControls.style.display = 'block';
            backgroundMusic.pause();
            bossMusic.pause();
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            canvas.style.cursor = 'default';
        }

               function playSound(type, pitch = 1) {
            if (!soundOn) return;
            let sound;
            switch (type) {
                case 'game-start': sound = gameStartSound; break;
                case 'laser': sound = laserSound; break;
                case 'hit': sound = hitSound; break;
                case 'explosion': sound = explosionSound; break;
                case 'powerup': sound = powerupSound; break;
                case 'gameover': sound = gameoverSound; break;
                case 'combo': sound = comboSound; break;
                case 'dash': sound = dashSound; break;
                default: return;
            }
            sound.currentTime = 0;
            sound.playbackRate = pitch; // Adjust pitch for variety
            sound.play().catch(error => console.log(`Sound ${type} failed to play:`, error));
        }

        // Initialize the game when the page loads
        window.onload = () => {
            init();
            setupEventListeners();
        };

        // Ensure cleanup on window close or refresh
        window.onbeforeunload = () => {
            backgroundMusic.pause();
            bossMusic.pause();
            if (autoFireInterval !== null) {
                clearInterval(autoFireInterval);
            }
            cancelAnimationFrame(animationFrameId);
        };
    </script>
</body>
</html>
